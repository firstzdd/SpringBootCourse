## 12.3 OAuth 2

OAuth （Open Authorization，开放授权）是一个关于授权的开放网络标准，它为用户资源的授权定义了一个安全、开放及简单的标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源（如照片，视频，联系人列表），而不需要将用户名和密码提供给第三方应用。OAuth 允许用户提供一个令牌，而不是用户名和密码来访问他们存放在特定服务提供者的数据。每一个令牌授权一个特定的网站在特定的时段内访问特定的资源。这样，OAuth 让用户可以授权第三方网站访问他们存储在另外服务提供者的某些特定信息，而非所有内容。

目前 OAuth 最新版本是 2.0，在全世界得到了广泛地应用，在国内主流的QQ，微信等第三方授权登录方式都是基于OAuth 2 实现的。

OAuth 2 在“客户端”与“服务提供商”之间，设置了一个授权层（authorization layer）。“客户端”不能直接登录“服务提供商”，只能登录授权层，以此将用户与客户端分离。“客户端”登录需要 OAuth 提供的令牌，否则将提示认证失败而导致客户端无法访问服务。

> 为了方便理解，可以想象 OAuth2.0 就是在用户资源和第三方应用之间的一个中间层（授权层 authorization layer），它把资源和第三方应用隔开，使得第三方应用无法直接访问资源，从而起到保护资源的作用。

本小节我们学习 Spring Boot 项目中是如何配置使用 OAuth 2 服务器端，并让 OAuth 2 整合 Spring Security 来保护我们的 REST 服务接口。

### 12.3.1 基本概念

OAuth 2 标准中定义了以下几种角色：

- 资源所有者（Resource Owner）：代表授权客户端访问本身资源信息的用户（User），如微信用户其具有头像、照片、朋友圈等资源。
- 资源服务器（Resource Server）：资源服务器托管了受保护的用户账号信息，可以向第三方提供资源，如头像、照片、朋友圈等资源。
- 授权服务器（Authorization Server）：授权服务器用来验证用户身份然后为客户端派发资源访问令牌。资源服务器接受此令牌并验证您的身份。
- 客户端（Client）：代表意图访问受限资源的第三方应用。在访问实现之前，它必须先经过用户者授权，并且获得的授权凭证将进一步由授权服务器进行验证。

我们以开发一个**无敌获客**应用为例来说明说明 OAuth 2.0 中的4种角色。

**无敌获客**应用需要在**微信**中分享出来一个活动页，该活动需要让**微信用户**去参与，这个**无敌获客**应用需要**收集到用户的姓名，头像，地域**等信息。

- 资源所有者 = **微信用户**；
- 资源服务器 = **微信服务器**，提供微信用户基本信息给到第三方应用 = 客户端 = **无敌获客**；
- 授权服务器 = **微信服务器**，该角色可以理解为管理其余三者关系的中间层；
- 客户端 = 第三方应用客户端 = **无敌获客**；

OAuht 2 解决问题的关键在于使用**授权服务器**提供一个**访问凭据**给到**第三方应用**，让**第三方应用**可以在不知道资源所有者在资源服务器上的账号和密码的情况下，能获取到资源所有者在资源服务器上的受保护资源（这里的受保护资源就是**微信用户的姓名以及头像等信息**）。

![image-20200202213035987](images/image-20200202213035987.png)

1. 客户端向用户（资源所有者）请求其授权；

2. 用户单击客户端所呈现的服务授权页面上的同意授权按钮后，客户端收到用户的授权许可，这个授权许可是一个代表资源所有者授权的凭据；

3. 客户端向授权服务器请求访问令牌，并出示授权许可；

4. 授权服务器对客户端身份进行认证，并校验授权许可，如果都是有效的，则发放访问令牌；

5. 客户端向资源服务器请求受保护的资源，并出示访问令牌；

6. 资源服务器校验访问令牌，如果令牌有效，则提供服务。

OAuth 2.0 提供了4种授权模式：

- 授权码 Authorization Code：是最常使用的一种授权许可类型，它适用于第三方应用类型为`server-side`型应用的场景。`Authorization Code`授权流程基于重定向跳转，客户端必须能够与`User-agent`（即用户的 Web 浏览器）交互并接收通过`User-agent`路由发送的实际`authorization code`值。适合普通服务器端应用使用；
- 简化（隐式）许可 Implicit：和`Authorization Code`基于重定向跳转的授权流程十分相似，但它适用于移动应用和 Web App，这些应用与普通服务器端应用相比有个特点，即`client secret`不能有效保存和信任；
- 资源所有者密码凭证 Resource Owner Password Credentials：适用于用户与客户端具有信任关系的情况，例如设备操作系统或同一组织的内部及外部应用。用户与应用交互表现形式往往体现为客户端能够直接获取用户凭据（用户名和密码，通常使用交互表单）；
- 客户端凭证 Client Credentials：是最简单的一种授权流程。客户端可以直接使用它的`client credentials`或其他有效认证信息向授权服务器发起获取`access token`的请求。

上面这4种授权模式，各有各的适用场景，我们在实际项目种需要根据项目类型选择使用。

1. 授权码模式：第三方Web服务器端应用与第三方原生App；
2. 简化模式：第三方单页面应用；
3. 密码模式：第一方单页应用与第一方原生App；
4. 客户端模式：没有用户参与的，完全信任的服务器端服务。


### 12.3.2 集成示例

Spring Boot 对 OAuth 2.0 提供了良好的集成，[官方文档](https://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/htmlsingle/#boot-features-security-oauth2)提供了简要的说明，[官方示例](https://spring.io/guides/tutorials/spring-boot-oauth2/)提供了详细的指导。

